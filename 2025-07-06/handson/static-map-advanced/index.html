<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>„É™„Ç¢„É´„ÉØ„Éº„É´„ÉâARPG„Éû„ÉÉ„Éó</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1a1a;
            color: #fff;
        }
        
        .header {
            background: rgba(0,0,0,0.8);
            padding: 15px 20px;
            backdrop-filter: blur(10px);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header h1 {
            font-size: 20px;
            font-weight: normal;
        }
        
        .mode-toggle {
            display: flex;
            gap: 10px;
        }
        
        .mode-btn {
            padding: 8px 16px;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            color: white;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.2s;
        }
        
        .mode-btn.active {
            background: #3b82f6;
            border-color: #3b82f6;
        }
        
        #map {
            height: 100vh;
            width: 100%;
        }
        
        /* „É≠„Ç±„Éº„Ç∑„Éß„É≥„Éû„Éº„Ç´„Éº */
        .quest-marker {
            width: 40px;
            height: 40px;
            background: radial-gradient(circle, #fbbf24 0%, #f59e0b 100%);
            border: 3px solid white;
            border-radius: 50%;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .quest-marker.completed {
            background: radial-gradient(circle, #10b981 0%, #059669 100%);
        }
        
        .quest-marker:hover {
            transform: scale(1.2);
        }
        
        /* „Éó„É¨„Ç§„É§„Éº‰ΩçÁΩÆ„Éû„Éº„Ç´„Éº */
        .player-marker {
            width: 30px;
            height: 30px;
            background: #3b82f6;
            border: 3px solid white;
            border-radius: 50%;
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.5);
            position: relative;
        }
        
        .player-marker::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 50px;
            height: 50px;
            border: 2px solid #3b82f6;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% {
                transform: translate(-50%, -50%) scale(1);
                opacity: 1;
            }
            100% {
                transform: translate(-50%, -50%) scale(2);
                opacity: 0;
            }
        }
        
        /* Ë∑ùÈõ¢„Ç§„É≥„Ç∏„Ç±„Éº„Çø„Éº */
        .distance-indicator {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.8);
            padding: 15px 30px;
            border-radius: 30px;
            backdrop-filter: blur(10px);
            z-index: 1000;
            text-align: center;
        }
        
        .distance-text {
            font-size: 18px;
            margin-bottom: 5px;
        }
        
        .distance-hint {
            font-size: 14px;
            color: #9ca3af;
        }
        
        /* „Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó„Ç´„Çπ„Çø„Éû„Ç§„Ç∫ */
        .leaflet-popup-content-wrapper {
            background: rgba(0,0,0,0.9);
            color: white;
            border-radius: 8px;
            backdrop-filter: blur(10px);
        }
        
        .leaflet-popup-tip {
            background: rgba(0,0,0,0.9);
        }
        
        .quest-popup {
            padding: 10px;
            min-width: 200px;
        }
        
        .quest-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 8px;
            color: #fbbf24;
        }
        
        .quest-desc {
            margin-bottom: 10px;
            line-height: 1.4;
        }
        
        .quest-reward {
            font-size: 14px;
            color: #10b981;
            margin-bottom: 10px;
        }
        
        .quest-distance {
            font-size: 14px;
            color: #9ca3af;
        }
        
        /* AR „É¢„Éº„Éâ UI */
        .ar-overlay {
            position: fixed;
            top: 80px;
            left: 20px;
            right: 20px;
            background: rgba(0,0,0,0.8);
            padding: 15px;
            border-radius: 8px;
            backdrop-filter: blur(10px);
            z-index: 1000;
            display: none;
        }
        
        .ar-overlay.active {
            display: block;
        }
        
        .ar-compass {
            text-align: center;
            font-size: 24px;
            margin-bottom: 10px;
        }
        
        .ar-direction {
            text-align: center;
            color: #fbbf24;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>„É™„Ç¢„É´„ÉØ„Éº„É´„ÉâARPG</h1>
        <div class="mode-toggle">
            <button class="mode-btn active" onclick="setMode('map')">„Éû„ÉÉ„Éó</button>
            <button class="mode-btn" onclick="setMode('ar')">AR„É¢„Éº„Éâ</button>
        </div>
    </div>
    
    <div id="map"></div>
    
    <div class="ar-overlay" id="arOverlay">
        <div class="ar-compass">üß≠ <span id="compassHeading">0</span>¬∞</div>
        <div class="ar-direction">ÊúÄÂØÑ„Çä„ÅÆ„ÇØ„Ç®„Çπ„Éà: <span id="nearestQuest">-</span></div>
    </div>
    
    <div class="distance-indicator" id="distanceIndicator">
        <div class="distance-text">ÊúÄÂØÑ„Çä„ÅÆ„ÇØ„Ç®„Çπ„Éà„Åæ„Åß <span id="nearestDistance">-</span></div>
        <div class="distance-hint">ÂÆüÈöõ„ÅÆÂ†¥ÊâÄ„Å´ÁßªÂãï„Åó„Å¶„ÇØ„É™„Ç¢ÔºÅ</div>
    </div>
    
    <!-- Leaflet JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    
    <script>
        // „Éû„ÉÉ„Éó„É¢„Éº„ÉâÁÆ°ÁêÜ
        let currentMode = 'map';
        let playerLocation = null;
        let playerMarker = null;
        let watchId = null;
        
        // „Éû„ÉÉ„Éó„ÅÆÂàùÊúüÂåñÔºàÂÆüÈöõ„ÅÆÂú∞Âõ≥„Å®„Ç≤„Éº„É†„Éû„ÉÉ„Éó„ÅÆÂàá„ÇäÊõø„ÅàÂèØËÉΩÔºâ
        const map = L.map('map', {
            center: [35.6762, 139.6503], // Êù±‰∫¨ÈßÖÂë®Ëæ∫
            zoom: 15
        });
        
        // „Éô„Éº„Çπ„É¨„Ç§„É§„ÉºÔºàÂÆüÈöõ„ÅÆÂú∞Âõ≥Ôºâ
        const streetLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors'
        });
        
        // „ÉÄ„Éº„ÇØ„ÉÜ„Éº„Éû„ÅÆÂú∞Âõ≥
        const darkLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            attribution: '¬© OpenStreetMap contributors & CartoDB'
        });
        
        darkLayer.addTo(map);
        
        // „ÇØ„Ç®„Çπ„Éà„É≠„Ç±„Éº„Ç∑„Éß„É≥ÔºàÂÆüÈöõ„ÅÆÂ∫ßÊ®ô„Å´„Éû„ÉÉ„Éî„É≥„Ç∞Ôºâ
        const quests = [
            {
                id: 1,
                name: "Á´ú„ÅÆÈñÄ",
                desc: "Âè§‰ª£„ÅÆÂÆàË≠∑Á´ú„ÅåÁú†„ÇãÂ†¥ÊâÄ",
                reward: "ÁµåÈ®ìÂÄ§ +500, „Ç¥„Éº„É´„Éâ +100",
                lat: 35.6762,
                lng: 139.6503,
                level: 1
            },
            {
                id: 2,
                name: "È≠îÊ≥ï„ÅÆÊ≥â",
                desc: "Áôí„Åó„ÅÆÂäõ„ÇíÊåÅ„Å§Á•ûÁßòÁöÑ„Å™Ê≥â",
                reward: "HPÂÖ®ÂõûÂæ©, MP +50",
                lat: 35.6785,
                lng: 139.6520,
                level: 2
            },
            {
                id: 3,
                name: "ÂïÜ‰∫∫„ÅÆÂ∫ÉÂ†¥",
                desc: "Áèç„Åó„ÅÑ„Ç¢„Ç§„ÉÜ„É†„ÅåÊâã„Å´ÂÖ•„Çã",
                reward: "„É¨„Ç¢„Ç¢„Ç§„ÉÜ„É†Áç≤Âæó„ÉÅ„É£„É≥„Çπ",
                lat: 35.6740,
                lng: 139.6480,
                level: 1
            },
            {
                id: 4,
                name: "Ë©¶Á∑¥„ÅÆÂ°î",
                desc: "Âº∑Âäõ„Å™„Éú„Çπ„ÅåÂæÖ„Å°Âèó„Åë„Çã",
                reward: "„É¨„Ç∏„Çß„É≥„ÉÄ„É™„ÉºË£ÖÂÇô",
                lat: 35.6795,
                lng: 139.6550,
                level: 5
            }
        ];
        
        // „ÇØ„Ç®„Çπ„ÉàÂÆå‰∫ÜÁä∂ÊÖã
        let completedQuests = JSON.parse(localStorage.getItem('completedQuests')) || {};
        
        // „ÇØ„Ç®„Çπ„Éà„Éû„Éº„Ç´„Éº„ÅÆ‰ΩúÊàê
        const questMarkers = {};
        quests.forEach(quest => {
            const icon = L.divIcon({
                className: 'custom-icon',
                html: `<div class="quest-marker ${completedQuests[quest.id] ? 'completed' : ''}">${quest.level}</div>`,
                iconSize: [40, 40],
                iconAnchor: [20, 20],
                popupAnchor: [0, -20]
            });
            
            const marker = L.marker([quest.lat, quest.lng], { icon }).addTo(map);
            
            marker.bindPopup(`
                <div class="quest-popup">
                    <div class="quest-title">${quest.name}</div>
                    <div class="quest-desc">${quest.desc}</div>
                    <div class="quest-reward">Â†±ÈÖ¨: ${quest.reward}</div>
                    <div class="quest-distance" id="distance-${quest.id}">Ë∑ùÈõ¢: Ë®àÊ∏¨‰∏≠...</div>
                </div>
            `);
            
            questMarkers[quest.id] = marker;
        });
        
        // ‰ΩçÁΩÆÊÉÖÂ†±„ÅÆÂèñÂæó„Å®Êõ¥Êñ∞
        function startLocationTracking() {
            if ("geolocation" in navigator) {
                watchId = navigator.geolocation.watchPosition(
                    (position) => {
                        updatePlayerLocation(position.coords.latitude, position.coords.longitude);
                    },
                    (error) => {
                        console.error("‰ΩçÁΩÆÊÉÖÂ†±„Ç®„É©„Éº:", error);
                        // „Éá„É¢Áî®„ÅÆ„Ç∑„Éü„É•„É¨„Éº„Éà‰ΩçÁΩÆ
                        simulatePlayerMovement();
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 5000,
                        maximumAge: 0
                    }
                );
            } else {
                // ‰ΩçÁΩÆÊÉÖÂ†±„Åå‰Ωø„Åà„Å™„ÅÑÂ†¥Âêà„ÅØ„Ç∑„Éü„É•„É¨„Éº„Éà
                simulatePlayerMovement();
            }
        }
        
        // „Éó„É¨„Ç§„É§„Éº‰ΩçÁΩÆ„ÅÆÊõ¥Êñ∞
        function updatePlayerLocation(lat, lng) {
            playerLocation = { lat, lng };
            
            if (!playerMarker) {
                const icon = L.divIcon({
                    className: 'custom-icon',
                    html: '<div class="player-marker"></div>',
                    iconSize: [30, 30],
                    iconAnchor: [15, 15]
                });
                playerMarker = L.marker([lat, lng], { icon }).addTo(map);
            } else {
                playerMarker.setLatLng([lat, lng]);
            }
            
            // Ëøë„Åè„ÅÆ„ÇØ„Ç®„Çπ„Éà„Çí„ÉÅ„Çß„ÉÉ„ÇØ
            checkNearbyQuests();
            updateDistances();
        }
        
        // Ë∑ùÈõ¢Ë®àÁÆó
        function calculateDistance(lat1, lng1, lat2, lng2) {
            const R = 6371e3; // Âú∞ÁêÉ„ÅÆÂçäÂæÑÔºà„É°„Éº„Éà„É´Ôºâ
            const œÜ1 = lat1 * Math.PI/180;
            const œÜ2 = lat2 * Math.PI/180;
            const ŒîœÜ = (lat2-lat1) * Math.PI/180;
            const ŒîŒª = (lng2-lng1) * Math.PI/180;
            
            const a = Math.sin(ŒîœÜ/2) * Math.sin(ŒîœÜ/2) +
                      Math.cos(œÜ1) * Math.cos(œÜ2) *
                      Math.sin(ŒîŒª/2) * Math.sin(ŒîŒª/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            
            return R * c;
        }
        
        // Ë∑ùÈõ¢„ÅÆÊõ¥Êñ∞
        function updateDistances() {
            if (!playerLocation) return;
            
            let nearestQuest = null;
            let nearestDistance = Infinity;
            
            quests.forEach(quest => {
                const distance = calculateDistance(
                    playerLocation.lat, playerLocation.lng,
                    quest.lat, quest.lng
                );
                
                // „Éù„ÉÉ„Éó„Ç¢„ÉÉ„ÉóÂÜÖ„ÅÆË∑ùÈõ¢„ÇíÊõ¥Êñ∞
                const distanceEl = document.getElementById(`distance-${quest.id}`);
                if (distanceEl) {
                    distanceEl.textContent = `Ë∑ùÈõ¢: ${formatDistance(distance)}`;
                }
                
                if (distance < nearestDistance && !completedQuests[quest.id]) {
                    nearestDistance = distance;
                    nearestQuest = quest;
                }
            });
            
            // ÊúÄÂØÑ„Çä„ÅÆ„ÇØ„Ç®„Çπ„ÉàÊÉÖÂ†±„ÇíÊõ¥Êñ∞
            if (nearestQuest) {
                document.getElementById('nearestDistance').textContent = formatDistance(nearestDistance);
                document.getElementById('nearestQuest').textContent = nearestQuest.name;
            }
        }
        
        // Ë∑ùÈõ¢„ÅÆ„Éï„Ç©„Éº„Éû„ÉÉ„Éà
        function formatDistance(meters) {
            if (meters < 1000) {
                return `${Math.round(meters)}m`;
            } else {
                return `${(meters / 1000).toFixed(1)}km`;
            }
        }
        
        // Ëøë„Åè„ÅÆ„ÇØ„Ç®„Çπ„Éà„Çí„ÉÅ„Çß„ÉÉ„ÇØÔºà50m‰ª•ÂÜÖ„Åß„ÇØ„É™„Ç¢ÂèØËÉΩÔºâ
        function checkNearbyQuests() {
            if (!playerLocation) return;
            
            quests.forEach(quest => {
                if (completedQuests[quest.id]) return;
                
                const distance = calculateDistance(
                    playerLocation.lat, playerLocation.lng,
                    quest.lat, quest.lng
                );
                
                if (distance < 50) { // 50m‰ª•ÂÜÖ
                    completeQuest(quest);
                }
            });
        }
        
        // „ÇØ„Ç®„Çπ„ÉàÂÆå‰∫Ü
        function completeQuest(quest) {
            completedQuests[quest.id] = true;
            localStorage.setItem('completedQuests', JSON.stringify(completedQuests));
            
            // „Éû„Éº„Ç´„Éº„ÇíÊõ¥Êñ∞
            const icon = L.divIcon({
                className: 'custom-icon',
                html: `<div class="quest-marker completed">${quest.level}</div>`,
                iconSize: [40, 40],
                iconAnchor: [20, 20],
                popupAnchor: [0, -20]
            });
            questMarkers[quest.id].setIcon(icon);
            
            // ÂÆå‰∫ÜÈÄöÁü•
            alert(`„ÇØ„Ç®„Çπ„Éà„Äå${quest.name}„Äç„Çí„ÇØ„É™„Ç¢ÔºÅ\n${quest.reward}`);
        }
        
        // „É¢„Éº„ÉâÂàá„ÇäÊõø„Åà
        function setMode(mode) {
            currentMode = mode;
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.classList.toggle('active', btn.textContent.toLowerCase().includes(mode));
            });
            
            document.getElementById('arOverlay').classList.toggle('active', mode === 'ar');
            
            if (mode === 'ar') {
                startCompass();
            }
        }
        
        // „Ç≥„É≥„Éë„ÇπÊ©üËÉΩÔºàAR„É¢„Éº„ÉâÁî®Ôºâ
        function startCompass() {
            if (window.DeviceOrientationEvent) {
                window.addEventListener('deviceorientation', (event) => {
                    const heading = event.alpha;
                    document.getElementById('compassHeading').textContent = Math.round(heading);
                });
            }
        }
        
        // „Éá„É¢Áî®Ôºö„Éó„É¨„Ç§„É§„Éº„ÅÆÂãï„Åç„Çí„Ç∑„Éü„É•„É¨„Éº„Éà
        function simulatePlayerMovement() {
            let lat = 35.6762;
            let lng = 139.6503;
            
            setInterval(() => {
                lat += (Math.random() - 0.5) * 0.0002;
                lng += (Math.random() - 0.5) * 0.0002;
                updatePlayerLocation(lat, lng);
            }, 3000);
        }
        
        // ÂàùÊúüÂåñ
        startLocationTracking();
        
        // Âú∞Âõ≥„Çí„Éó„É¨„Ç§„É§„Éº‰ΩçÁΩÆ„Å´‰∏≠ÂøÉ„ÇíÂêà„Çè„Åõ„Çã
        setInterval(() => {
            if (playerLocation && currentMode === 'map') {
                map.panTo([playerLocation.lat, playerLocation.lng]);
            }
        }, 5000);
    </script>
</body>
</html>