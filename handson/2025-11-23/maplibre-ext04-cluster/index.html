<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>MapLibre クラスター</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.css" />
    <style>
        body { margin: 0; padding: 0; }
        #map { width: 100%; height: 100vh; }
    </style>
</head>
<body>
    <div id="map"></div>
    <script src="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.js"></script>
    <script>
        const map = new maplibregl.Map({
            container: 'map',
            style: {
                version: 8,
                glyphs: 'https://demotiles.maplibre.org/font/{fontstack}/{range}.pbf',
                sources: {
                    'gsi-pale': {
                        type: 'raster',
                        tiles: [
                            'https://cyberjapandata.gsi.go.jp/xyz/pale/{z}/{x}/{y}.png'
                        ],
                        tileSize: 256,
                        attribution: '&copy; <a href="https://maps.gsi.go.jp/development/ichiran.html">国土地理院</a>'
                    }
                },
                layers: [
                    {
                        id: 'gsi-pale-layer',
                        type: 'raster',
                        source: 'gsi-pale',
                        minzoom: 0,
                        maxzoom: 18
                    }
                ]
            },
            center: [139.7671, 35.6812],
            zoom: 10,
            pitch: 0,
            bearing: 0
        });
        
        map.addControl(new maplibregl.NavigationControl());
        
        map.on('load', function() {
            // クラスター用データソース
            map.addSource('stations-cluster', {
                type: 'geojson',
                data: {
                    type: 'FeatureCollection',
                    features: [
                        { type: 'Feature', geometry: { type: 'Point', coordinates: [139.7671, 35.6812] }, properties: { name: '東京駅', passengers: 462000 } },
                        { type: 'Feature', geometry: { type: 'Point', coordinates: [139.7006, 35.6896] }, properties: { name: '新宿駅', passengers: 775000 } },
                        { type: 'Feature', geometry: { type: 'Point', coordinates: [139.7016, 35.6580] }, properties: { name: '渋谷駅', passengers: 379000 } },
                        { type: 'Feature', geometry: { type: 'Point', coordinates: [139.7387, 35.6284] }, properties: { name: '品川駅', passengers: 379000 } },
                        { type: 'Feature', geometry: { type: 'Point', coordinates: [139.7109, 35.7295] }, properties: { name: '池袋駅', passengers: 558000 } },
                        { type: 'Feature', geometry: { type: 'Point', coordinates: [139.7638, 35.6938] }, properties: { name: '秋葉原駅', passengers: 250000 } },
                        { type: 'Feature', geometry: { type: 'Point', coordinates: [139.7452, 35.6939] }, properties: { name: '四ツ谷駅', passengers: 180000 } },
                        { type: 'Feature', geometry: { type: 'Point', coordinates: [139.6760, 35.6989] }, properties: { name: '中野駅', passengers: 150000 } },
                        { type: 'Feature', geometry: { type: 'Point', coordinates: [139.7780, 35.6813] }, properties: { name: '錦糸町駅', passengers: 120000 } },
                        { type: 'Feature', geometry: { type: 'Point', coordinates: [139.7215, 35.7309] }, properties: { name: '赤羽駅', passengers: 140000 } }
                    ]
                },
                cluster: true,
                clusterMaxZoom: 14, // クラスターを解除する最大ズームレベル
                clusterRadius: 50 // クラスター半径（ピクセル）
            });
            
            // クラスターの円
            map.addLayer({
                id: 'clusters',
                type: 'circle',
                source: 'stations-cluster',
                filter: ['has', 'point_count'], // クラスターのみ
                paint: {
                    'circle-color': [
                        'step',
                        ['get', 'point_count'],
                        '#51bbd6',
                        3,
                        '#f1f075',
                        5,
                        '#f28cb1'
                    ],
                    'circle-radius': [
                        'step',
                        ['get', 'point_count'],
                        20,
                        3,
                        30,
                        5,
                        40
                    ]
                }
            });
            
            // クラスター内のポイント数
            map.addLayer({
                id: 'cluster-count',
                type: 'symbol',
                source: 'stations-cluster',
                filter: ['has', 'point_count'],
                layout: {
                    'text-field': '{point_count_abbreviated}',
                    'text-font': ['Noto Sans Regular'],
                    'text-size': 12
                },
                paint: {
                    'text-color': '#ffffff'
                }
            });
            
            // クラスター化されていない個別ポイント
            map.addLayer({
                id: 'unclustered-point',
                type: 'circle',
                source: 'stations-cluster',
                filter: ['!', ['has', 'point_count']], // クラスターでないもの
                paint: {
                    'circle-color': '#11b4da',
                    'circle-radius': 8,
                    'circle-stroke-width': 2,
                    'circle-stroke-color': '#fff'
                }
            });
            
            // クラスターをクリックで拡大
            map.on('click', 'clusters', function(e) {
                const features = map.queryRenderedFeatures(e.point, {
                    layers: ['clusters']
                });
                const clusterId = features[0].properties.cluster_id;
                map.getSource('stations-cluster').getClusterExpansionZoom(
                    clusterId,
                    function(err, zoom) {
                        if (err) return;
                        
                        map.easeTo({
                            center: features[0].geometry.coordinates,
                            zoom: zoom
                        });
                    }
                );
            });
            
            // 個別ポイントをクリックでポップアップ
            map.on('click', 'unclustered-point', function(e) {
                const coordinates = e.features[0].geometry.coordinates.slice();
                const properties = e.features[0].properties;
                
                new maplibregl.Popup()
                    .setLngLat(coordinates)
                    .setHTML('<strong>' + properties.name + '</strong><br>乗降客数: ' + properties.passengers.toLocaleString() + '人/日')
                    .addTo(map);
            });
            
            // カーソル変更
            map.on('mouseenter', 'clusters', function() {
                map.getCanvas().style.cursor = 'pointer';
            });
            map.on('mouseleave', 'clusters', function() {
                map.getCanvas().style.cursor = '';
            });
            
            map.on('mouseenter', 'unclustered-point', function() {
                map.getCanvas().style.cursor = 'pointer';
            });
            map.on('mouseleave', 'unclustered-point', function() {
                map.getCanvas().style.cursor = '';
            });
        });
    </script>
</body>
</html>