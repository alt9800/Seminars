<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Deck.gl 基本の地図</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { margin: 0; padding: 0; font-family: Arial, sans-serif; }
        #map { width: 100%; height: 100vh; position: relative; }
        #controls {
            position: absolute;
            top: 10px;
            left: 10px;
            background: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            z-index: 1;
        }
        #controls button {
            display: block;
            margin: 5px 0;
            padding: 8px 12px;
            cursor: pointer;
            border: none;
            background: #007cbf;
            color: white;
            border-radius: 3px;
        }
        #controls button:hover {
            background: #005a8c;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <div id="controls">
        <strong>背景地図切り替え</strong>
        <button onclick="changeBaseMap('osm')">OpenStreetMap</button>
        <button onclick="changeBaseMap('gsi')">国土地理院</button>
        <button onclick="changeBaseMap('carto')">Carto Light</button>
    </div>
    
    <script src="https://unpkg.com/deck.gl@9.0.0/dist.min.js"></script>
    
    <script>
        let deckgl;
        let currentTileLayer;
        
        // 背景地図のタイル設定
        const baseMaps = {
            osm: {
                name: 'OpenStreetMap',
                url: 'https://tile.openstreetmap.org/{z}/{x}/{y}.png',
                attribution: '© OpenStreetMap contributors'
            },
            gsi: {
                name: '国土地理院',
                url: 'https://cyberjapandata.gsi.go.jp/xyz/pale/{z}/{x}/{y}.png',
                attribution: '© 国土地理院'
            },
            carto: {
                name: 'Carto Light',
                url: 'https://basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png',
                attribution: '© OpenStreetMap contributors © CARTO'
            }
        };
        
        // タイルレイヤーを作成する関数
        function createTileLayer(mapKey) {
            const mapConfig = baseMaps[mapKey];
            return new deck.TileLayer({
                id: 'tile-layer',
                data: mapConfig.url,
                minZoom: 0,
                maxZoom: 19,
                tileSize: 256,
                renderSubLayers: props => {
                    const {
                        bbox: {west, south, east, north}
                    } = props.tile;
                    
                    return new deck.BitmapLayer(props, {
                        data: null,
                        image: props.data,
                        bounds: [west, south, east, north]
                    });
                }
            });
        }
        
        // 主要駅データ（ScatterplotLayer用）
        const stationsData = [
            { name: '東京駅', coordinates: [139.7671, 35.6812], passengers: 462000 },
            { name: '新宿駅', coordinates: [139.7006, 35.6896], passengers: 775000 },
            { name: '渋谷駅', coordinates: [139.7016, 35.6580], passengers: 379000 },
            { name: '品川駅', coordinates: [139.7387, 35.6284], passengers: 379000 },
            { name: '池袋駅', coordinates: [139.7109, 35.7295], passengers: 558000 }
        ];
        
        // GeoJSON形式のパスデータ
        const pathData = {
            type: 'FeatureCollection',
            features: [
                {
                    type: 'Feature',
                    properties: { name: '中央線', color: [255, 99, 71] },
                    geometry: {
                        type: 'LineString',
                        coordinates: [
                            [139.7003573288469, 35.691239928314374],
                            [139.7009635407017, 35.68820849667566],
                            [139.69578888654496, 35.68369419472977],
                            [139.6875474637206, 35.67832317143727],
                            [139.68017274365303, 35.67583437982546],
                            [139.6676212831522, 35.6734214567513],
                            [139.65915365759162, 35.67072037158694],
                            [139.6510055510484, 35.668539799401145],
                            [139.64190275546554, 35.66589306040666],
                            [139.6326221009918, 35.66738232477873],
                            [139.6240861011417, 35.668152685857876],
                            [139.61514396851464, 35.669913763965226],
                            [139.60986015831952, 35.67079428322272],
                            [139.601331512042, 35.66793266851582],
                            [139.58480410266674, 35.662319842064704],
                            [139.57538175409587, 35.65830669802037],
                            [139.5669694195912, 35.65422992235908],
                            [139.55914740892905, 35.65035573108334],
                            [139.55210343625362, 35.64969588326824],
                            [139.54438400157323, 35.65167794492214]
                        ]
                    }
                }
            ]
        };
        
        // Deck.glの初期化
        function initDeckGL(baseMapKey = 'osm') {
            currentTileLayer = createTileLayer(baseMapKey);
            
            deckgl = new deck.DeckGL({
                container: 'map',
                initialViewState: {
                    longitude: 139.65,
                    latitude: 35.67,
                    zoom: 11,
                    pitch: 0,
                    bearing: 0
                },
                controller: true,
                getTooltip: ({object}) => object && object.name && {
                    html: `<strong>${object.name}</strong><br/>乗降客数: ${object.passengers.toLocaleString()}人/日`,
                    style: {
                        backgroundColor: '#333',
                        color: '#fff',
                        padding: '10px',
                        borderRadius: '5px'
                    }
                },
                layers: [
                    currentTileLayer,
                    // PathLayer - GeoJSON形式の路線
                    new deck.PathLayer({
                        id: 'path-layer',
                        data: pathData.features,
                        getPath: d => d.geometry.coordinates,
                        getColor: d => d.properties.color,
                        getWidth: 5,
                        widthMinPixels: 2,
                        pickable: true,
                        autoHighlight: true,
                        highlightColor: [255, 255, 0, 150]
                    }),
                    // ScatterplotLayer - 駅のポイント
                    new deck.ScatterplotLayer({
                        id: 'stations',
                        data: stationsData,
                        getPosition: d => d.coordinates,
                        getRadius: d => Math.sqrt(d.passengers) * 2,
                        getFillColor: [255, 140, 0],
                        pickable: true,
                        radiusMinPixels: 5,
                        radiusMaxPixels: 50,
                        autoHighlight: true,
                        highlightColor: [255, 255, 0, 150]
                    })
                ]
            });
        }
        
        // 背景地図を切り替える関数
        function changeBaseMap(mapKey) {
            currentTileLayer = createTileLayer(mapKey);
            
            deckgl.setProps({
                layers: [
                    currentTileLayer,
                    new deck.PathLayer({
                        id: 'path-layer',
                        data: pathData.features,
                        getPath: d => d.geometry.coordinates,
                        getColor: d => d.properties.color,
                        getWidth: 5,
                        widthMinPixels: 2,
                        pickable: true,
                        autoHighlight: true,
                        highlightColor: [255, 255, 0, 150]
                    }),
                    new deck.ScatterplotLayer({
                        id: 'stations',
                        data: stationsData,
                        getPosition: d => d.coordinates,
                        getRadius: d => Math.sqrt(d.passengers) * 2,
                        getFillColor: [255, 140, 0],
                        pickable: true,
                        radiusMinPixels: 5,
                        radiusMaxPixels: 50,
                        autoHighlight: true,
                        highlightColor: [255, 255, 0, 150]
                    })
                ]
            });
        }
        
        // 初期化実行
        initDeckGL('osm');
    </script>
</body>
</html>