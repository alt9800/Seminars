<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Deck.gl グリッド押出</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { margin: 0; padding: 0; }
        #map { width: 100%; height: 100vh; position: relative; }
    </style>
</head>
<body>
    <div id="map"></div>
    <script src="https://unpkg.com/deck.gl@9.0.0/dist.min.js"></script>
    <script>
        // ランダムなグリッドデータを生成
        const gridData = [];
        const gridSize = 0.01; // グリッドのサイズ（経度緯度単位）
        const centerLng = 139.7671;
        const centerLat = 35.6812;
        const gridCount = 20; // 20x20のグリッド
        
        for (let i = 0; i < gridCount; i++) {
            for (let j = 0; j < gridCount; j++) {
                const lng = centerLng - (gridCount / 2) * gridSize + i * gridSize;
                const lat = centerLat - (gridCount / 2) * gridSize + j * gridSize;
                gridData.push({
                    position: [lng, lat],
                    value: Math.random() * 100
                });
            }
        }
        
        const deckgl = new deck.DeckGL({
            container: 'map',
            initialViewState: {
                longitude: 139.7671,
                latitude: 35.6812,
                zoom: 12,
                pitch: 45,
                bearing: 0
            },
            controller: true,
            layers: [
                new deck.TileLayer({
                    id: 'base-map',
                    data: 'https://cyberjapandata.gsi.go.jp/xyz/pale/{z}/{x}/{y}.png',
                    minZoom: 0,
                    maxZoom: 19,
                    tileSize: 256,
                    renderSubLayers: props => {
                        const {bbox: {west, south, east, north}} = props.tile;
                        return new deck.BitmapLayer(props, {
                            data: null,
                            image: props.data,
                            bounds: [west, south, east, north]
                        });
                    }
                }),
                new deck.GridCellLayer({
                    id: 'grid-cell-layer',
                    data: gridData,
                    getPosition: d => d.position,
                    getElevation: d => d.value * 10,
                    cellSize: gridSize * 111000, // メートル単位に変換
                    elevationScale: 5,
                    extruded: true,
                    getFillColor: d => [255, (1 - d.value / 100) * 255, 0],
                    pickable: true
                })
            ],
            getTooltip: ({object}) => object && {
                html: `<strong>値: ${object.value.toFixed(2)}</strong>`,
                style: {
                    backgroundColor: '#333',
                    color: '#fff',
                    padding: '10px',
                    borderRadius: '5px'
                }
            }
        });
    </script>
</body>
</html>